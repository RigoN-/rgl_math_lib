<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=KOI8-R">

<title>
Программирование в Linux с нуля - Глава3. БИБЛИОТЕКИ
</title></head>
<body bgcolor="#DDE1C2">
<link rel="stylesheet" href="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/opennet4.css" type="text/css">
<!--htdig_noindex-->
<form method="get" action="http://www.opennet.ru/search.shtml">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tbody><tr>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" bgcolor="#E9EAD6" valign="BOTTOM">
<a href="http://www.opennet.ru/"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/opennet2.gif" alt="The OpenNET Project" border="0" height="60" width="249"></a><br>
</td>

<td bgcolor="#B0B190" width="1"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="1" width="1"></td>

<td align="RIGHT" bgcolor="#D9DAC6" valign="TOP" width="470">
<table cellpadding="1" border="0" width="470">
<tbody><tr>
<td bgcolor="#D9DAC6" height="60">

<script language="JavaScript">            
var plugin=(navigator.mimeTypes && navigator.mimeTypes["application/x-shockwave-flash"]) ? navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin : 0;           
           
if ( plugin ) {           
           
 plugin=parseInt(plugin.description.substring(plugin.description.indexOf(".")-2))>=6;           
           
}           
           
else if (navigator.userAgent && navigator.userAgent.indexOf("MSIE")>=0            
           
   && (navigator.userAgent.indexOf("Windows 95")>=0 || navigator.userAgent.indexOf("Windows 98")>=0 || navigator.userAgent.indexOf("Windows NT")>=0)) {           
           
 document.write('<SCR'+'IPT LANGUAGE=VBScript\> \n');           
           
 document.write('on error resume next \n');           
           
 document.write('plugin=( IsObject(CreateObject("ShockwaveFlash.ShockwaveFlash.6")))\n');           
           
 document.write('</SCRIPT\> \n');           
           
}           
           
if ( plugin ) {           
           
     var swf_url = '/img/securit7.swf' + '?link1=' + 'http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?securit7';  
     document.write('<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width=468 height=60>');  
     document.write('<param name=movie value="' + swf_url + '"><param name=menu value=false><param name=quality value=high><param name="play" value="true">');  
     document.write('<OBJECT TYPE="application/x-shockwave-flash" data="' + swf_url + '" width=468 height=60>');  
     document.write('<param name=movie value="' + swf_url + '"><param name=menu value=false><param name=quality value=high><param name="play" value="true">');  
     document.write('</object>');  
     document.write('</object>');  
                                            
}else{                  
    document.write('<a href=http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?securit7 target=_blank><img src=/img/securit7.gif width=468 height=60 border=0></a>');                                            
}            
</script><object class="xctojuhmzdefxuzdqsbl" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" height="60" width="468"><param name="movie" value="/img/securit7.swf?link1=http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?securit7"><param name="menu" value="false"><param name="quality" value="high"><param name="play" value="true"><object class="xctojuhmzdefxuzdqsbl" type="application/x-shockwave-flash" data="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/securit7.swf" height="60" width="468"><param name="movie" value="/img/securit7.swf?link1=http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?securit7"><param name="menu" value="false"><param name="quality" value="high"><param name="play" value="true"></object></object>           
<noscript><a href=http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?securit7 target=_blank><img src=/img/securit7.gif width=468 height=60 border=0></a></noscript>


</td>
</tr>
</tbody></table>
</td>

<td bgcolor="#B0B190" width="1"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="1" width="1"></td>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" bgcolor="#E9EAD6" width="40">&nbsp;</td>
<td bgcolor="#B0B190" width="1"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="1" width="1"></td>

<td rowspan="3" align="RIGHT" bgcolor="#E9EAD6" valign="TOP" width="130">
<a href="http://www.lanbilling.ru/" target="_blank"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/lanbilling7.gif" border="0" height="125" width="130"></a>
</td>

</tr>

<tr bgcolor="#B0B190"><td colspan="6"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="1" width="1"></td></tr>


<tr bgcolor="#E9EAD6">
<td colspan="5" align="CENTER">
<table width="100%">
<tbody><tr>
<td rowspan="2" class="h" nowrap="nowrap" width="300">
<input name="exclude" value="index|/man.shtml" type="hidden"><a href="http://www.opennet.ru/search.shtml" class="h"><u>Поиск</u></a>&nbsp;(<a href="http://www.opennet.ru/keywords/" class="h">ключи</a>):&nbsp;<input size="20" name="words" title="для поиска в google наберите &quot;g фраза&quot;" type="text">
</td><td width="25%">
&nbsp;   <a href="http://www.opennet.ru/prog/sml/" class="h"><b><u>ПРОГРАММЫ</u></b></a>
</td><td width="25%">
   <a href="http://www.opennet.ru/filebase.shtml" class="h"><b><u>СТАТЬИ</u></b></a>
</td><td width="25%">
   <a href="http://www.opennet.ru/tips/sml/" class="h"><b><u>СОВЕТЫ</u></b></a>
</td><td width="25%">
   <a href="http://www.opennet.ru/forum/" class="h"><b><u>ФОРУМ</u></b></a>
</td></tr>
<tr><td>
&nbsp;   <a href="http://wiki.opennet.ru/" class="h"><b><u>WIKI</u></b></a>
</td><td class="h">
   <a href="http://www.opennet.ru/opennews/" class="h"><b><u>НОВОСТИ</u></b></a> (<a href="http://www.opennet.ru/news/opennet.shtml" class="h">+</a>)
</td><td>
   <a href="http://www.opennet.ru/man.shtml" class="h"><b><u>MAN'ы</u></b></a>
</td><td>
   <a href="http://www.opennet.ru/docs/" class="h"><b><u>ДОКУМЕНТАЦИЯ</u></b></a>
</td></tr>
</tbody></table>
</td>
<td bgcolor="#B0B190" width="1"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="1" width="1"></td>
</tr>
<tr bgcolor="#B0B190"><td colspan="7"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="2" width="1"></td></tr>
</tbody></table>

<div style="float: left; width: 279; text-align: left;padding-right: 60px; height: 40px;" id="adv"><a href="http://www.ip-as.ru/" target="_blank"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/ipas3.gif" border="0" height="40" width="279"></a></div>
<div style="padding-top: 0px;position:absolute;left:50%;margin-left:-235px;width:470px;" id="adv2">
<iframe class="xctojuhmzdefxuzdqsbl" src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/adv_hts.html" name="hts" border="0" target="_blank" marginheight="0" marginwidth="0" frameborder="0" height="63" scrolling="no" width="468"></iframe>
</div>
<div style="width: 279;float: right;" id="adv3"><!-- <A HREF="http://www.carbonsoft.ru/carbon_billing/?utm_source=opennetSTEAM140214&utm_medium=banner&utm_campaign=carbon_billing5_box" target=_blank><IMG SRC="/img/carbon5.jpg" BORDER="0" width="279" height="40"></A>--></div>
<div style="clear: both;"></div>

<br>

<script language="JavaScript"><!--
d=document;a='';r=escape(d.referrer);a+=';r='+r;
js=10; d.write('<img src="http://top.list.ru/counter'+
'?id=77689;js='+js+a+';rand='+Math.random()+
'" alt="" height=1 width=1>');
if(js>11)d.write('<'+'!-- ')//--></script><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/counter_002.gif" alt="" height="1" width="1"><noscript><img
src="http://top.list.ru/counter?js=na;id=77689"
height=1 width=1 alt="">
</noscript>

</form>
<!--/htdig_noindex-->


<table style="margin-bottom: 5px;margin-top: 5px;" cellpadding="0" cellspacing="0" border="0" width="100%">
<tbody><tr><td>
<table cellpadding="4" cellspacing="0" bgcolor="#E9EAD6" border="0" width="100%">
<tbody><tr bgcolor="#C7CBB1"><td><font color="#000090">
<b><a href="http://www.opennet.ru/docs/">Каталог документации</a> / 
<a href="http://www.opennet.ru/docs/124.shtml">Раздел "Программирование, языки"</a> /
<a href="http://www.opennet.ru/docs/RUS/zlp/">Оглавление документа</a>
</b>
</font></td></tr>
</tbody></table>
</td></tr>
<tr bgcolor="#B0B190"><td><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/p.gif" alt="" height="3" width="1"></td></tr>
</tbody></table>

<a href="http://www.opennet.ru/docs/RUS/zlp/index.html">Оглавление</a>
<hr noshade="noshade">
<h2>Глава 3. БИБЛИОТЕКИ</h2>

<a href="http://www.opennet.ru/docs/RUS/zlp/003.html#1">3.1. Введение в библиотеки</a><br>
<a href="http://www.opennet.ru/docs/RUS/zlp/003.html#2">3.2. Пример статической библиотеки</a><br>
<a href="http://www.opennet.ru/docs/RUS/zlp/003.html#3">3.3. Пример совместно используемой библиотеки</a><br>

<a name="1"><h3>3.1. Введение в библиотеки</h3></a>
<p align="justify">
Как уже неоднократно упоминалось в предыдущей главе, <i>библиотека</i> - это
набор скомпонованных особым образом объектных файлов. Библиотеки подключаются к
основной программе во время линковки. По способу компоновки библиотеки
подразделяют на <i>архивы</i> (статические библиотеки, static libraries) и
<i>совместно используемые</i> (динамические библиотеки, shared libraries). В
Linux, кроме того, есть механизмы <i>динамической подгрузки</i> библиотек.
Суть динамической подгрузки состоит в том, что запущенная программа может по
собственному усмотрению подключить к себе какую-либо библиотеку. Благодаря этой
возможности создаются программы с <i>подключаемыми плагинами</i>, такие как
XMMS. В этой главе мы не будем рассматривать динамическую подгрузку, а
остановимся на классическом использовании статических и динамических библиотек.
</p>

<p align="justify">
С точки зрения модели КИС, библиотека - это сервер. Библиотеки несут в себе
одну важную мысль: возможность использовать одни и те же механизмы в разных
программах. В Linux библиотеки используются повсеместно, поскольку это очень
удобный способ "не изобретать велосипеды". Даже ядро Linux в каком-то смысле
представляет собой библиотеку механизмов, называемых <i>системными
вызовами</i>.
</p>

<p align="justify">
Статическая библиотека - это просто архив объектных файлов, который
подключается к программе во время линковки. Эффект такой же, как если бы вы
подключали каждый из файлов отдельно.
</p>

<p align="justify">
В отличие от статических библиотек, код совместно используемых (динамических)
библиотек не включается в бинарник. Вместо этого в бинарник включается только
<i>ссылка</i> на библиотеку.
</p>

<p align="justify">
Рассмотрим преимущества и недостатки статических и совместно используемых
библиотек. Статические библиотеки делают программу более автономной: программа,
скомпонованная со статической библиотекой может запускаться на любом
компьютере, не требуя наличия этой библиотеки (она уже "внутри" бинарника).
Программа, скомпонованная с динамической библиотекой, требует наличия этой
библиотеки на том компьютере, где она запускается, поскольку в бинарнике не
код, а ссылка на код библиотеки. Не смотря на такую зависимость, динамические
библиотеки обладают двумя существенными преимуществами. Во-первых, бинарник,
скомпонованный с совместно используемой библиотекой меньше размером, чем такой
же бинарник, с подключенной к нему статической библиотекой (статически
скомпонованный бинарник). Во-вторых, любая модернизация динамической
библиотеки, отражается на всех программах, использующих ее. Таким образом, если
некоторую библиотеку foo используют 10 программ, то исправление какой-нибудь
ошибки в foo или любое другое улучшение библиотеки автоматически улучшает все
программы, которые используют эту библиотеку. Именно поэтому динамические
библиотеки называют совместно используемыми. Чтобы применить изменения,
внесенные в статическую библиотеку, нужно пересобрать все 10 программ.
</p>

<p align="justify">
В Linux статические библиотеки обычно имеют расширение <b>.a</b> (Archive), а
совместно используемые библиотеки имеют расширение <b>.so</b> (Shared Object).
Хранятся библиотеки, как правило, в каталогах /lib и /usr/lib. В случае иного
расположения (относится только к совместно используемым библиотекам),
приходится немного "подшаманить", чтобы программа запустилась.
</p>

<a name="2"><h3>3.2. Пример статической библиотеки</h3></a>

<p align="justify">
Теперь давайте создадим свою собственную библиотеку, располагающую двумя
функциями: h_world() и g_world(), которые выводят на экран "Hello World" и
"Goodbye World" соответственно. Начнем со статической библиотеки.
</p>

<p align="justify">
Начнем с интерфейса. Создадим файл world.h:
</p><pre><font color="#4466ff"><b>
/* world.h */
void h_world (void);
void g_world (void);
</b></font>
</pre>

Здесь просто объявлены функции, которые будут использоваться.
<p></p>

<p align="justify">
Теперь надо реализовать серверы. Создадим файл h_world.c:
</p><pre><font color="#4466ff"><b>
/* h_world.c */
#include &lt;stdio.h&gt;
#include "world.h"

void h_world (void)
{
        printf ("Hello World\n");
}
</b></font>
</pre>

Теперь создадим файл g_world.c, содержащий реализацию функции g_world():

<pre><font color="#4466ff"><b>
/* g_world.c */
#include &lt;stdio.h&gt;
#include "world.h"

void g_world (void)
{
        printf ("Goodbye World\n");
}
</b></font>
</pre>

Можно было бы с таким же успехом уместить обе функции в одном файле (hello.c,
например), однако для наглядности мы разнесли код на два файла.
<p></p>

<p align="justify">
Теперь создадим файл main.c. Это клиент, который будет пользоваться услугами
сервера:

</p><pre><font color="#4466ff"><b>
/* main.c */
#include "world.h"

int main (void)
{
        h_world ();
        g_world ();
}
</b></font>
</pre>
<p></p>

<p align="justify">
Теперь напишем сценарий для make. Для этого создаем Makefile:

</p><pre><font color="#4466ff"><b>
# Makefile for World project

binary: main.o libworld.a
        gcc -o binary main.o -L. -lworld

main.o: main.c
        gcc -c main.c

libworld.a: h_world.o g_world.o
        ar cr libworld.a h_world.o g_world.o

h_world.o: h_world.c
        gcc -c h_world.c

g_world.o: g_world.c
        gcc -c g_world.c

clean:
        rm -f *.o *.a binary
</b></font>
</pre>

Не забывайте ставить табуляции перед каждым правилом в целевых связках.
<p></p>

<p align="justify">
Собираем программу:

</p><pre><font color="#ff6644">
$ make
gcc -c main.c
gcc -c h_world.c
gcc -c g_world.c
ar cr libworld.a h_world.o g_world.o
gcc -o binary main.o -L. -lworld
$
</font>
</pre>
<p></p>

<p align="justify">
Осталось только проверить, работает ли программа и разобраться, что же мы такое
сделали:

</p><pre><font color="#ff6644">
$ ./binary
Hello World
Goodbye World
$
</font>
</pre>
<p></p>

<p align="justify">
Итак, в приведенном примере появились три новые вещи: опции <b>-l</b> и
<b>-L</b> компилятора, а также команда <b>ar</b>. Начнем с последней. Как вы
уже догадались, команда ar создает статическую библиотеку (архив). В нашем
случае два объектных файла объединяются в один файл libworld.a. В Linux
практически все библиотеки имеют префикс lib.
</p>

<p align="justify">
Как уже говорилось, компилятор gcc сам вызывает линковщик, когда это нужно.
Опция -l, переданная компилятору, обрабатывается и посылается линковщику для
того, чтобы тот подключил к бинарнику библиотеку. Как вы уже заметили, у имени
библиотеки "обрублены" префикс и суффикс. Это делается для того, чтобы создать
"видимое безразличие" между статическими и динамическими библиотеками. Но об
этом речь пойдет в других главах книги. Сейчас важно знать лишь то, что
 и библиотека libfoo.so и библиотека libfoo.a подключаются к проекту опцией
<b>-lfoo</b>. В нашем случае libworld.a "урезалось" до -lworld.
</p>

<p align="justify">
Опция -L указывает линковщику, где ему искать библиотеку. В случае, если
библиотека располагается в каталоге /lib или /usr/lib, то вопрос отпадает сам
собой и опция -L не требуется. В нашем случае библиотека находится в
репозитории (в текущем каталоге). По умолчанию линковщик не просматривает
текущий каталог в поиске библиотеки, поэтому опция -L. (точка означает текущий
каталог) необходима.
</p>

<a name="3"><h3>3.3. Пример совместно используемой библиотеки</h3></a>
<p align="justify">
Для того, чтобы создать и использовать динамическую (совместно используемую)
библиотеку, достаточно переделать в нашем проекте Makefile.

</p><pre><font color="#4466ff"><b>
# Makefile for World project

binary: main.o libworld.so
	gcc -o binary main.o -L. -lworld -Wl,-rpath,.

main.o: main.c
	gcc -c main.c

libworld.so: h_world.o g_world.o
	gcc -shared -o libworld.so h_world.o g_world.o

h_world.o: h_world.c
	gcc -c -fPIC h_world.c

g_world.o: g_world.c
	gcc -c -fPIC g_world.c

clean:
	rm -f *.o *.so binary
</b></font>
</pre>
<p></p>

<p align="justify">
Внешне ничего не изменилось: программа компилируется, запускается и выполняет
те же самые действия, что и в предыдущем случае. Изменилась <b>внутренняя
суть</b>, которая играет для программиста первоочередную роль. Рассмотрим все
по порядку.
</p>

<p align="justify">
Правило для сборки binary теперь содержит пугающую опцию <b>-Wl,-rpath,.</b>
Ничего страшного тут нет. Как уже неоднократно говорилось, компилятор gcc сам
вызывает линковщик ld, когда это надо и передает ему нужные параметры сборки,
избавляя нас от ненужной платформенно-зависимой волокиты. Но иногда мы все-таки
должны вмешаться в этот процесс и передать линковщику "свою" опцию. Для этого
используется опция компилятора <b>-Wl,option,optargs,...</b> Расшифровываю:
передать линковщику (-Wl) опцию option с аргументами optargs. В нашем случае мы
передаем линковщику опцию -rpath с аргументом . (точка, текущий каталог).
Возникает вопрос: что означает опция -rpath? Как уже говорилось, линковщик ищет
библиотеки в определенных местах; обычно это каталоги /lib и /usr/lib, иногда
/usr/local/lib. Опция -rpath просто добавляет к этому списку еще один каталог.
В нашем случае это текущий каталог. Без указания опции -rpath, линковщик
"молча" соберет программу, но при запуске нас будет ждать сюрприз: программа не
запустится из-за отсутствия библиотеки. Попробуйте убрать опцию -Wl,-rpath,. из
Makefile и пересоберите проект. При попытке запуска программа binary завершится
с кодом возврата 127 (о кодах возврата будет рассказано в последующих главах).
То же самое произойдет, если вызвать программу из другого каталога. Верните
обратно -Wl,-rpath,., пересоберите проект, поднимитесь на уровень выше командой
cd .. и попробуйте запустить бинарник командой world/binary. Ничего не
получится, поскольку в новом текущем каталоге библиотеки нет.
</p>

<p align="justify">
Есть один способ не передавать линковщику дополнительных опций при помощи -Wl -
это использование переменной окружения LD_LIBRARY_PATH. В последующих главах мы
будем подробно касаться темы окружения (environment). Сейчас лишь скажу, что у
каждого пользователя есть так называемое окружение (environment) представляющее
собой набор пар ПЕРЕМЕННАЯ=ЗНАЧЕНИЕ, используемых программами. Чтобы посмотреть
окружение, достаточно набрать команду env. Чтобы добавить в окружение
переменную, достаточно набрать export ПЕРЕМЕННАЯ=ЗНАЧЕНИЕ, а чтобы удалить
переменную из окружения, надо набрать export -n ПЕРЕМЕННАЯ. Будьте внимательны:
export - это <b>внутреннаяя команда оболочки BASH</b>; в других оболочках (csh,
ksh, ...) используются другие команды для работы с окружением. Переменная
окружения LD_LIBRARY_PATH содержит список дополнительных "мест", разделенных 
двоеточиеями, где линковщих должен искать библиотеку.
</p>

<p align="justify">
Не смотря на наличие двух механизмов передачи информации о
нестандартном расположении библиотек, лучше помещать библиотеки в конечных
проектах в /lib и в /usr/lib. Допускается расположение библиотек в подкаталоги
/usr/lib и в /usr/local/lib (с указанем -Wl,-rpath). Но заставлять конечного
пользователя устанавливать LD_LIBRARY_PATH почти всегда является плохим
стилем программирования.
</p>

<p align="justify">
Следующая немаловажная деталь - это процесс создания самой библиотеки.
Статические библиотеки создаются при помощи архиватора ar, а совместно
используемые - при помощи gcc с опцией -shared. В данном случае gcc
опять же вызывает линковщик, но не для сборки бинарника, а для создания
динамической библиотеки.
</p>

<p align="justify">
Последнее отличие - опциии -fPIC (-fpic) при компиляции h_world.c и g_world.c.
Эта опция сообщает компилятору, что объектные файлы, полученные в результате
компиляции должны содержать <b>позиционно-независимый код</b> (PIC - Position
Independent Code), который используется в динамических библиотеках. В таком
коде используются не фиксированные позиции (адреса), а плавающие, благодаря
чему код из библиотеки имеет возможность подключаться к программе в момент
запуска.
</p>
<hr noshade="noshade">
<div align="center">
<font color="#777777" size="-1">
Copyright © 2003-2006, 2007 Nikolay N. Ivanov<br>
Distributed under the GNU Free Documentaton License
</font>
</div>


<!--htdig_noindex-->
<noindex>
<br>

<table id="ibm_adv" align="center"><tbody><tr valign="top"><td width="383">
<iframe class="xctojuhmzdefxuzdqsbl" src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/adv_ibm.html" name="lc" border="0" target="_blank" frameborder="0" height="240" scrolling="no" width="383"></iframe>
</td><td>
<iframe class="xctojuhmzdefxuzdqsbl" src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/adv_lc.html" name="ibm" border="0" target="_blank" marginheight="0" marginwidth="0" frameborder="0" height="240" scrolling="no" width="605"></iframe>
</td></tr></tbody></table>

</noindex>
<!--/htdig_noindex-->


<!-- footer -->
<!--htdig_noindex-->
<br>
<table cellpadding="1" cellspacing="0" bgcolor="#B0B190" border="0" width="100%">
<tbody><tr><td>
<table valign="MIDDLE" cellpadding="0" cellspacing="0" border="0" width="100%">
<tbody><tr>
<td align="LEFT" bgcolor="#E9EAD6" width="35%">
<font size="-1">
&nbsp;&nbsp;<a href="http://www.opennet.ru/cgi-bin/opennet/bookmark.cgi">Закладки&nbsp;на&nbsp;сайте</a><br>
&nbsp;&nbsp;<a href="http://www.opennet.ru/cgi-bin/opennet/bookmark.cgi?submit=add" target="blank_">Проследить&nbsp;за&nbsp;страницей</a>
</font>
</td>
<td align="RIGHT" bgcolor="#E9EAD6" width="65%">
<font size="-1">Created&nbsp;1996-2014&nbsp;by&nbsp;<b><a href="http://www.opennet.ru/contact.shtml" title="email mc@tyumen.ru">Maxim&nbsp;Chirkov</a></b></font>&nbsp;&nbsp;<br>
<font size="-1"><a href="http://www.opennet.ru/add.shtml">Добавить</a>,&nbsp;<a href="http://www.opennet.ru/reklama.shtml">Реклама</a>,&nbsp;<a href="http://www.opennet.ru/banners2.shtml">Вебмастеру</a>,&nbsp;<a href="http://www.opennet.ru/guide.shtml">ГИД</a></font>&nbsp;&nbsp;
</td>
</tr>
</tbody></table>
</td></tr>
</tbody></table>


<div align="right"><table><tbody><tr><td>
<a target="_blank" href="http://www.runnet.ru/"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/runnet.gif" alt="RUNNet" border="0" height="31" width="88"></a>
<a target="_blank" href="http://top.list.ru/jump?from=77689"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/counter.gif" alt="TopList" border="0" height="31" width="38"></a>
<script type="text/javascript"><!--
document.write("<a href='http://www.liveinternet.ru/click' "+
"target=_blank><img src='//counter.yadro.ru/hit?t45.6;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";"+Math.random()+
"' alt='' title='LiveInternet' "+
"border='0' width='31' height='31'><\/a>")
//--></script><a href="http://www.liveinternet.ru/click" target="_blank"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/hit.gif" alt="" title="LiveInternet" border="0" height="31" width="31"></a>
<a target="_blank" href="http://counter.rambler.ru/top100/"><img src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/top100.gif" border="0" height="1" width="1"><img class="xctojuhmzdefxuzdqsbl" src="%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B2%20Linux%20%D1%81%20%D0%BD%D1%83%D0%BB%D1%8F%20-%20%D0%93%D0%BB%D0%B0%D0%B2%D0%B03.%20%D0%91%D0%98%D0%91%D0%9B%D0%98%D0%9E%D0%A2%D0%95%D0%9A%D0%98_files/banner.gif" border="0" height="31" width="88"></a>
</td></tr></tbody></table>
</div>

<!--/htdig_noindex-->
<!-- end of footer -->


</body></html>